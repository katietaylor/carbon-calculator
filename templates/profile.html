{% extends 'base.html' %}

{% block title %} Profile {% endblock %}

{% block content %}

<h1>{{ name }}'s Profile </h1>

<!-- Residence ############################################################ -->

<h2>Residences</h2>
{% if residences %}
    <table>
        <tr>
            <th>House Name or Address</th>
            <th>Zipcode</th> 
            <th>Residents</th>
            <th>Default</th>
        </tr>
        {% for residence in residences %}
        <tr>
            <th>{{ residence.name_or_address }}</th>
            <th>{{ residence.zipcode_id }}</th>
            <th>{{ residence.number_of_residents }}</th>
            <th>{{ residence.is_default }}</th>
        </tr>
        {% endfor %}
    </table>
{% else %}
    <h2>No residences added</h2>
{% endif %}
<br>

<form action="/add-residence" method="POST">
    House Name or Address: <input type="text" name="name_or_address"> <br>
    zipcode: <input type="text" name="zipcode"> <br>
    number of residents? <input type="text" name="no_residents"> <br>
    set as default?: <input type="checkbox" name="default"> <br>

    <input type="submit" value="Add Residence">
</form>

<!-- Cars ################################################################# -->

<h2>Cars</h2>
{% if usercars %}
    <table>
        <tr>
            <th>Make</th>
            <th>Model</th> 
            <th>Year</th>
            <th>Default</th>
        </tr>
        {% for usercar in usercars %}
        <tr>
            <th>{{ usercar.car.make }}</th>
            <th>{{ usercar.car.model }}</th>
            <th>{{ usercar.car.year }}</th>
            <th>{{ usercar.is_default }}</th>
        </tr>
        {% endfor %}
    </table>
{% else %}
    <h2>No cars added</h2>
{% endif %}
<br>

<form action="/add-car", id="add-car" method="POST">
    Make: <select name="make", id="make">
        <option selected="selected" disabled="disabled">SELECT CAR MAKE</option>
    {% for make in makes %}
        <option value="{{ make }}">{{ make }}</option>
    {% endfor %}
    </select><br>
    Model: <select name="model", id="model">

    </select><br>
    Year: <select name="year", id="year">
 
    </select><br>
    set as default?: <input type="checkbox" name="default"> <br>

    <input type="submit" value="Add Car">
</form>

<script type="text/javascript">
    "use strict";

    var make = $("#make");
    var model = $("#model");
    var year = $("#year");

    make.on("change", onMakeChange);
    model.on("change", onModelChange);
    year.on("change", onYearChange);

    function onMakeChange(evt) {
        var data = {};
        data.make = make.val();

        $.ajax({
            url: "/car-data",
            data: data,
            success: function(response) {
                
                model.empty();
                model.append("<option value=''>SELECT MODEL</option>");
                var modelsFound = [];

                // create a list of unique models
                $.each(response, function(i,car) {
                    console.log(car);
                    if ($.inArray(car.model, modelsFound) == -1) {
                        modelsFound.push(car.model);
                    }
                })
                // sort the list and append it to the Model dropdown list
                $.each(modelsFound.sort(), function(i,carModel) {
                    model.append("<option value='"+carModel+"'>"+carModel+"</option>");
                })
                
                year.empty();
                year.append("<option value=''>SELECT YEAR</option>");
                var yearsFound = [];

                // create a list of unique years
                $.each(response, function(i,car) {
                    console.log(car);
                    if ($.inArray(car.year, yearsFound) == -1) {
                        yearsFound.push(car.year);
                    }
                })
                // sort the list and append it to the Year dropdown list
                $.each(yearsFound.sort(), function(i,carYear) {
                    year.append("<option value='"+carYear+"'>"+carYear+"</option>");
                })
            },
            error: function(response) {

            }
        })
    }

    function onModelChange(evt) {
        var data = {};
        data.make = make.val();
        data.model = model.val();
        var selectedYear = year.val();

        $.ajax({
            url: "/car-data",
            data: data,
            success: function(response) {

                year.empty();
                year.append("<option value=''>SELECT YEAR</option>");
                var yearsFound = [];

                // create a list of unique years
                $.each(response, function(i,car) {
                    console.log(car);
                    if ($.inArray(car.year, yearsFound) == -1) {
                        yearsFound.push(car.year);
                    }
                })
                // sort the list and append it to the Year dropdown list
                $.each(yearsFound.sort(), function(i,carYear) {
                    var optionSelected = "";
                    // if year has already been selected, keep current year as selected value
                    if (carYear.toString() == selectedYear) {
                            optionSelected = "selected='selected'";
                        }
                    year.append("<option " + optionSelected + " value='"+carYear+"'>"+carYear+"</option>");
                })
            },
            error: function(response) {

            }
        })
    }


    function onYearChange(evt) {
        var data = {};
        data.make = make.val();
        data.year = year.val();
        var selectedModel = model.val();

        $.ajax({
            url: "/car-data",
            data: data,
            success: function(response) {

                model.empty();
                model.append("<option value=''>SELECT YEAR</option>");
                var modelsFound = [];

                // create a list of unique models
                $.each(response, function(i,car) {
                    console.log(car);
                    if ($.inArray(car.model, modelsFound) == -1) {
                        modelsFound.push(car.model);
                    }
                })
                // sort the list and append it to the Model dropdown list
                $.each(modelsFound.sort(), function(i,carModel) {
                    var optionSelected = "";
                    // if model has already been selected, keep current model as selected value
                    if (carModel == selectedModel) {
                            optionSelected = "selected='selected'";
                        }
                    model.append("<option " + optionSelected + " value='"+carModel+"'>"+carModel+"</option>");
                })
            },
            error: function(response) {

            }
        })
    }


</script>


{% endblock %}